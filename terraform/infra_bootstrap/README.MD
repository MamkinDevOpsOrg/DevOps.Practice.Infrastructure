# –ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å S3-–±–∞–∫–µ—Ç –¥–ª—è ALB Access Logs —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π ACL –∏ –æ–±—â–∏–º –ø—Ä–µ—Ñ–∏–∫—Å–æ–º

–≠—Ç–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —Å–æ–∑–¥–∞—ë—Ç S3-–±–∞–∫–µ—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è access-–ª–æ–≥–æ–≤ ALB, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏ –∑–∞–¥–∞—ë—Ç –≥–∏–±–∫–∏–π –ø—Ä–µ—Ñ–∏–∫—Å (`app1-prod`, `dev-alb`, –∏ —Ç.–ø.). –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º–∞ —Å Terraform –∏ AWS —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏.

---

### ‚úÖ –®–∞–≥ 1: –ó–∞–¥–∞—Ç—å –∏–º—è –±–∞–∫–µ—Ç–∞ –∏ –ø—Ä–µ—Ñ–∏–∫—Å

```bash
BUCKET_NAME="alb-access-logs-storage-for-mamkindevops-production"
LOG_PREFIX="app1-prod" # –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ dev, prod, app2, test –∏ —Ç.–¥.
```

---

### ‚úÖ –®–∞–≥ 2: –°–æ–∑–¥–∞—Ç—å S3-–±–∞–∫–µ—Ç –≤ —Ä–µ–≥–∏–æ–Ω–µ us-east-1

```bash
aws s3api create-bucket \
  --bucket "$BUCKET_NAME" \
  --region us-east-1
```

üìå –í `us-east-1` –Ω–µ —É–∫–∞–∑—ã–≤–∞–µ–º `--create-bucket-configuration` ‚Äî —ç—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å —Ä–µ–≥–∏–æ–Ω–∞.

---

### ‚ùì –ü–æ—á–µ–º—É –≤ us-east-1 –Ω–µ —É–∫–∞–∑—ã–≤–∞–µ–º `--create-bucket-configuration` –∏ —á—Ç–æ –¥–µ–ª–∞—Ç—å –≤ –¥—Ä—É–≥–∏—Ö —Ä–µ–≥–∏–æ–Ω–∞—Ö

–ö–æ–≥–¥–∞ —Å–æ–∑–¥–∞—ë—à—å S3-–±–∞–∫–µ—Ç, –ø–æ–≤–µ–¥–µ–Ω–∏–µ AWS –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–µ–≥–∏–æ–Ω–∞:

- –í `us-east-1` (–í–∏—Ä–¥–∂–∏–Ω–∏—è) **–Ω–µ–ª—å–∑—è —É–∫–∞–∑—ã–≤–∞—Ç—å** `--create-bucket-configuration`.  
  ‚úÖ –ü—Ä–∏–º–µ—Ä –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã:

```bash
aws s3api create-bucket \
  --bucket my-bucket \
  --region us-east-1
```

- –í–æ **–≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–∞—Ö** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `us-west-2`, `eu-central-1`) **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω–æ —É–∫–∞–∑—ã–≤–∞—Ç—å** `LocationConstraint`, –∏–Ω–∞—á–µ –±—É–¥–µ—Ç –æ—à–∏–±–∫–∞.  
  ‚úÖ –ü—Ä–∏–º–µ—Ä:

```bash
aws s3api create-bucket \
  --bucket my-bucket \
  --region us-west-2 \
  --create-bucket-configuration LocationConstraint=us-west-2
```

üß† –≠—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å —Ç–µ–º, —á—Ç–æ `us-east-1` ‚Äî –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏ –æ—Å–æ–±—ã–π —Ä–µ–≥–∏–æ–Ω, –∏ AWS –æ–∂–∏–¥–∞–µ—Ç –∏–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –æ—Ç API.

---

### üîÅ –ü—Ä–∏–º–µ—Ä —É—Å–ª–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–∏ –≤ bash-—Å–∫—Ä–∏–ø—Ç–µ (–¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏):

```bash
if [ "$REGION" = "us-east-1" ]; then
  aws s3api create-bucket \
    --bucket "$BUCKET_NAME" \
    --region "$REGION"
else
  aws s3api create-bucket \
    --bucket "$BUCKET_NAME" \
    --region "$REGION" \
    --create-bucket-configuration LocationConstraint="$REGION"
fi
```

üì¶ –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –±–∞–∫–µ—Ç –≤ –ª—é–±–æ–º —Ä–µ–≥–∏–æ–Ω–µ.

---

### ‚úÖ –®–∞–≥ 3: –ò–∑–º–µ–Ω–∏—Ç—å —Ä–µ–∂–∏–º –≤–ª–∞–¥–µ–Ω–∏—è –Ω–∞ BucketOwnerPreferred, –≤–∫–ª—é—á–∏—Ç—å ACL –∏ –¥–∞—Ç—å –ø—Ä–∞–≤–∞ LogDelivery

```bash
aws s3api put-bucket-ownership-controls \
  --bucket alb-access-logs-storage-for-mamkindevops-production \
  --ownership-controls 'Rules=[{ObjectOwnership=BucketOwnerPreferred}]' \
  --region us-east-1
```

```bash
aws s3api put-bucket-acl \
  --bucket "$BUCKET_NAME" \
  --grant-write 'URI="http://acs.amazonaws.com/groups/s3/LogDelivery"' \
  --grant-read-acp 'URI="http://acs.amazonaws.com/groups/s3/LogDelivery"' \
  --region us-east-1
```

üîê –ë–µ–∑ —ç—Ç–æ–≥–æ ALB –Ω–µ —Å–º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å –ª–æ–≥–∏ –≤ –±–∞–∫–µ—Ç, –¥–∞–∂–µ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ policy.

---

### ‚úÖ –®–∞–≥ 4: –°–æ–∑–¥–∞—Ç—å bucket policy —Å –≥–∏–±–∫–∏–º –ø—É—Ç—ë–º

–°–æ–∑–¥–∞–π `bucket-policy.json`:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AWSALBLogsWriteAccess",
      "Effect": "Allow",
      "Principal": {
        "Service": "logdelivery.elasticloadbalancing.amazonaws.com"
      },
      "Action": "s3:PutObject",
      "Resource": "arn:aws:s3:::alb-access-logs-storage-for-mamkindevops-production/*",
      "Condition": {
        "StringEquals": {
          "s3:x-amz-acl": "bucket-owner-full-control"
        }
      }
    },
    {
      "Sid": "AWSALBLogsGetAcl",
      "Effect": "Allow",
      "Principal": {
        "Service": "logdelivery.elasticloadbalancing.amazonaws.com"
      },
      "Action": "s3:GetBucketAcl",
      "Resource": "arn:aws:s3:::alb-access-logs-storage-for-mamkindevops-production"
    }
  ]
}
```

üìå –ú—ã —Ä–∞–∑—Ä–µ—à–∞–µ–º –≤—Å—ë –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ `/*`, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—é–±—ã–µ –ø—Ä–µ—Ñ–∏–∫—Å—ã (`app1-prod`, `dev`, `staging` –∏ —Ç.–¥.)

---

### ‚úÖ –®–∞–≥ 5: –ü—Ä–∏–º–µ–Ω–∏—Ç—å bucket policy

```bash
aws s3api put-bucket-policy \
  --bucket "$BUCKET_NAME" \
  --policy file://bucket-policy.json \
  --region us-east-1
```

---

### ‚úÖ –®–∞–≥ 6: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ Terraform

–í `terraform/environments/prod/variables.tf`:

```hcl
variable "access_log_bucket" {
  default = "alb-access-logs-storage-for-mamkindevops-production"
}

variable "access_log_prefix" {
  default = "app1-prod"
}
```

–í –º–æ–¥—É–ª–µ ALB:

```hcl
access_logs = {
  bucket  = var.access_log_bucket
  prefix  = var.access_log_prefix
  enabled = true
}
```

---

### üß† –ß—Ç–æ —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å:

| –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å                                 | –ë–ª–∞–≥–æ–¥–∞—Ä—è —á–µ–º—É                               |
| ------------------------------------------- | -------------------------------------------- |
| –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω –±–∞–∫–µ—Ç –¥–ª—è –º–Ω–æ–≥–∏—Ö ALB      | `prefix = ...`, `Resource = /*`              |
| –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å ALB                         | ACL + `x-amz-acl: bucket-owner-full-control` |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ GetBucketAcl + Condition | Bucket policy                                |
| –ë–µ–∑ –æ—à–∏–±–æ–∫ AccessDenied                     | ACL, policy, –ø—Ä–∞–≤–∞ LogDelivery               |
